from django.db import models
from django.core.mail import send_mail
from django.conf import settings


class Post(models.Model):
    """–ú–æ–¥–µ–ª—å Blog Post ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏—é (–∑–∞–ø–∏—Å—å –±–ª–æ–≥–∞).

    –≠—Ç–∞ –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–≥–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö, –≤–∫–ª—é—á–∞—è:
      - —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–∑–∞–≥–æ–ª–æ–≤–æ–∫, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –ø—Ä–µ–≤—å—é);
      - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏;
      - –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è;
      - —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.

    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:
      ‚Ä¢ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–∏—Å—å–º–æ –≤–ª–∞–¥–µ–ª—å—Ü—É —Å–∞–π—Ç–∞;
      ‚Ä¢ –ø–æ–ª–µ `views_count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–º. PostDetailView).

    –ê—Ç—Ä–∏–±—É—Ç—ã:
        title (str): –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–∞—Ö –∏ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ—Å—Ç–æ–≤.
        content (str): –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏ (HTML –∏–ª–∏ Markdown).
        preview (ImageField): –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–ø—Ä–µ–≤—å—é, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ—Å—Ç–æ–≤.
        created_at (datetime): –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞.
        is_published (bool): –§–ª–∞–≥, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ.
        views_count (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–∞. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ.

    –ú–µ—Ç–æ–¥—ã:
        __str__(): –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ (–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫).
        save(): –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ."""

    title = models.CharField(max_length=200, verbose_name="–ó–∞–≥–æ–ª–æ–≤–æ–∫")
    content = models.TextField(verbose_name="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ")
    preview = models.ImageField(
        upload_to="blog_previews/",
        blank=True,
        null=True,
        verbose_name="–ü—Ä–µ–≤—å—é (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)",
        help_text="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å—Ç–æ–≤ –∏–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–ª–æ–≥–∞.",
    )
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
    is_published = models.BooleanField(default=False, verbose_name="–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω")
    views_count = models.PositiveIntegerField(
        default=0, verbose_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"
    )

    class Meta:
        verbose_name = "–ë–ª–æ–≥–æ–≤–∞—è –∑–∞–ø–∏—Å—å"
        verbose_name_plural = "–ë–ª–æ–≥–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏"
        ordering = ["-created_at"]

    def __str__(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ ‚Äî –µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫."""
        return self.title

    def save(self, *args, **kwargs):
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ Post.
        –¶–µ–ª—å:
            –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∏
            –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
        –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
            - –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ save() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –æ–±—ä–µ–∫—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
            - –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è views_count.
            - –ï—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤—ã—Ä–æ—Å –∏ –≤–ø–µ—Ä–≤—ã–µ –¥–æ—Å—Ç–∏–≥ –∑–Ω–∞—á–µ–Ω–∏—è >= 100,
              –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ.
            - –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è send_mail() –∏–∑ Django.
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            *args, **kwargs: –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –º–µ—Ç–æ–¥–∞ save() –º–æ–¥–µ–ª–∏ Django.
        –ü—Ä–∏–º–µ—Ä:
            post.views_count = 100
            post.save()
            ‚Üí –ù–∞ –ø–æ—á—Ç—É alex@example.com –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
            –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ—á—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SMTP –≤ settings.py."""
        if self.pk:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–ø–µ—Ä–≤—ã–µ)
            old_post = Post.objects.filter(pk=self.pk).first()
            if old_post and old_post.views_count < 100 <= self.views_count:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
                send_mail(
                    subject="üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤!",
                    message=(
                        f"–í–∞—à –ø–æ—Å—Ç ¬´{self.title}¬ª –Ω–∞–±—Ä–∞–ª 100 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤!\n\n"
                        "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –≠—Ç–æ –æ—Ç–ª–∏—á–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ üéØ\n"
                        "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø–∏—Å–∞—Ç—å ‚Äî –∞—É–¥–∏—Ç–æ—Ä–∏—è —Ä–∞—Å—Ç—ë—Ç!"
                    ),
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[settings.ADMIN_EMAIL],  # üëà –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π email
                    fail_silently=False,
                )

        super().save(*args, **kwargs)


# –±–µ–∑ –¥–æ–ø –∑–∞–¥–∞–Ω–∏—è
# class Post(models.Model):
#     """–ú–æ–¥–µ–ª—å –±–ª–æ–≥–æ–≤–æ–π –∑–∞–ø–∏—Å–∏."""
#
#     title = models.CharField(max_length=200, verbose_name="–ó–∞–≥–æ–ª–æ–≤–æ–∫")
#     content = models.TextField(verbose_name="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ")
#     preview = models.ImageField(upload_to="blog_previews/", blank=True, null=True, verbose_name="–ü—Ä–µ–≤—å—é")
#     created_at = models.DateTimeField(auto_now_add=True, verbose_name="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
#     is_published = models.BooleanField(default=True, verbose_name="–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")
#     views_count = models.PositiveIntegerField(default=0, verbose_name="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã")
#
#     class Meta:
#         verbose_name = "–ü–æ—Å—Ç"
#         verbose_name_plural = "–ü–æ—Å—Ç—ã"
#         ordering = ["-created_at"]
#
#     def __str__(self):
#         return self.title
